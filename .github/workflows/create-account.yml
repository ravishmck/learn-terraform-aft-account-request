name: ğŸš€ Create AWS Account Request

# Simple workflow - runs directly in account-request repository
on:
  workflow_dispatch:
    inputs:
      account_name:
        description: 'ğŸ“ Account Name'
        required: true
        type: string
      
      account_email:
        description: 'ğŸ“§ Unique Account Email'
        required: true
        type: string
      
      organizational_unit:
        description: 'ğŸ¢ Organizational Unit'
        required: true
        type: choice
        options:
          - LearnMck
          - Sandbox
          - Batch14
          - Batch15
          - AFT-Lab-Rajesh
          - Security
          - SuspendedAccount
      
      environment:
        description: 'ğŸŒ Environment'
        required: true
        type: choice
        options:
          - Development
          - Testing
          - Staging
          - Production

jobs:
  create-request:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "AFT Automation"
          git config user.email "aft-automation@github.com"
      
      - name: ğŸ“ Create Account Request
        run: |
          # Generate safe module name
          MODULE_NAME=$(echo "${{ inputs.account_name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_')
          TIMESTAMP=$(date +%s)
          
          # Append to main.tf
          cat >> terraform/main.tf << EOF
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Account: ${{ inputs.account_name }}
          # Created: $(date '+%Y-%m-%d %H:%M:%S UTC')
          # Requested by: ${{ github.actor }}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          module "${MODULE_NAME}_${TIMESTAMP}" {
            source = "./modules/aft-account-request"
          
            control_tower_parameters = {
              AccountEmail              = "${{ inputs.account_email }}"
              AccountName               = "${{ inputs.account_name }}"
              ManagedOrganizationalUnit = "${{ inputs.organizational_unit }}"
              SSOUserEmail              = "ravish.snkhyn@gmail.com"
              SSOUserFirstName          = "Ravish"
              SSOUserLastName           = "Sankhyan"
            }
          
            account_tags = {
              "Environment"  = "${{ inputs.environment }}"
              "ManagedBy"    = "AFT"
              "RequestedBy"  = "${{ github.actor }}"
              "CreatedDate"  = "$(date +%Y-%m-%d)"
              "CreatedVia"   = "GitHub-Actions"
            }
          
            change_management_parameters = {
              change_requested_by = "${{ github.actor }}"
              change_reason       = "Account request via GitHub Actions"
            }
          
            custom_fields = {
              workflow_run_id = "${{ github.run_id }}"
              github_actor    = "${{ github.actor }}"
            }
          
            account_customizations_name = "sandbox"
          }
          EOF
          
          echo "âœ… Account request created!"
      
      - name: ğŸ’¾ Commit & Push
        run: |
          # Pull latest changes first (in case other workflows ran)
          git pull --rebase origin main || true
          
          git add terraform/main.tf
          git commit -m "ğŸš€ New Account: ${{ inputs.account_name }}

          ğŸ“‹ Details:
          â€¢ Name: ${{ inputs.account_name }}
          â€¢ Email: ${{ inputs.account_email }}
          â€¢ OU: ${{ inputs.organizational_unit }}
          â€¢ Environment: ${{ inputs.environment }}
          â€¢ Requested by: ${{ github.actor }}
          
          âš™ï¸ Will be auto-processed by AFT in ~2 minutes"
          
          # Push with retry logic
          for i in {1..3}; do
            if git push; then
              echo "âœ… Pushed successfully!"
              break
            else
              echo "âš ï¸  Push failed, pulling and retrying..."
              git pull --rebase origin main
            fi
          done
      
      - name: â° Wait for EventBridge Trigger
        run: |
          echo "â° Waiting 2 minutes for EventBridge to trigger CodePipeline..."
          sleep 120
          echo "âœ… EventBridge polling window passed"
      
      - name: ğŸ“Š Monitor Account Creation (Full Process)
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-south-1
          ACCOUNT_EMAIL: ${{ inputs.account_email }}
          ACCOUNT_NAME: ${{ inputs.account_name }}
          AFT_MGMT_ACCOUNT: "809574937450"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š MONITORING ACCOUNT CREATION PROCESS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Account: $ACCOUNT_NAME"
          echo "Email: $ACCOUNT_EMAIL"
          echo ""
          
          MAX_WAIT=30  # Maximum 30 minutes
          CHECK_COUNT=0
          ACCOUNT_CREATED=false
          
          # Function to check if AWS credentials are configured
          check_aws_creds() {
            if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
              echo "âš ï¸  AWS credentials not configured as secrets"
              echo "   Skipping automated monitoring"
              echo "   Please check manually at:"
              echo "   https://console.aws.amazon.com/organizations/v2/home/accounts"
              return 1
            fi
            return 0
          }
          
          if ! check_aws_creds; then
            echo ""
            echo "ğŸ’¡ To enable automated monitoring, add these GitHub secrets:"
            echo "   - AWS_ACCESS_KEY_ID"
            echo "   - AWS_SECRET_ACCESS_KEY"
            exit 0
          fi
          
          echo "âœ… AWS credentials configured"
          echo ""
          echo "ğŸ”„ Assuming role in AFT Management account ($AFT_MGMT_ACCOUNT)..."
          
          # Assume role to AFT Management account
          ROLE_OUTPUT=$(aws sts assume-role \
            --role-arn "arn:aws:iam::${AFT_MGMT_ACCOUNT}:role/AWSControlTowerExecution" \
            --role-session-name "GitHubActions-Monitoring" \
            --duration-seconds 3600 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âš ï¸  Failed to assume role to AFT Management account"
            echo "$ROLE_OUTPUT"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ACCOUNT REQUEST SUBMITTED SUCCESSFULLY!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Account: $ACCOUNT_NAME"
            echo "Email: $ACCOUNT_EMAIL"
            echo ""
            echo "âš ï¸  Automated monitoring unavailable (assume role failed)"
            echo ""
            echo "ğŸ“‹ Check status manually:"
            echo "   - CodePipeline: https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view"
            echo "   - Organizations: https://console.aws.amazon.com/organizations/v2/home/accounts"
            echo ""
            echo "ğŸ’¡ To fix monitoring:"
            echo "   1. Verify GitHub secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY"
            echo "   2. Ensure credentials are for Management account (535355705679)"
            echo "   3. Verify Management account can assume AWSControlTowerExecution role"
            echo ""
            exit 0
          fi
          
          # Extract and export temporary credentials (using Python instead of jq)
          export AWS_ACCESS_KEY_ID=$(echo "$ROLE_OUTPUT" | python3 -c "import sys, json; print(json.load(sys.stdin)['Credentials']['AccessKeyId'])")
          export AWS_SECRET_ACCESS_KEY=$(echo "$ROLE_OUTPUT" | python3 -c "import sys, json; print(json.load(sys.stdin)['Credentials']['SecretAccessKey'])")
          export AWS_SESSION_TOKEN=$(echo "$ROLE_OUTPUT" | python3 -c "import sys, json; print(json.load(sys.stdin)['Credentials']['SessionToken'])")
          
          echo "âœ… Successfully assumed role in AFT Management account"
          echo ""
          
          # Monitor loop
          for ((i=1; i<=MAX_WAIT; i++)); do
            CHECK_COUNT=$i
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â° CHECK #$i/$MAX_WAIT - $(date '+%H:%M:%S')"
            echo ""
            
            # Check 1: CodePipeline Status
            echo "1ï¸âƒ£ Checking CodePipeline..."
            PIPELINE_STATUS=$(aws codepipeline get-pipeline-state \
              --name ct-aft-account-request \
              --region ap-south-1 \
              --query 'stageStates[0].latestExecution.status' \
              --output text 2>/dev/null || echo "Unknown")
            echo "   Status: $PIPELINE_STATUS"
            
            # Check 2: DynamoDB Entry
            echo ""
            echo "2ï¸âƒ£ Checking DynamoDB..."
            DDB_ENTRY=$(aws dynamodb get-item \
              --table-name aft-request \
              --key "{\"id\": {\"S\": \"$ACCOUNT_EMAIL\"}}" \
              --region ap-south-1 \
              --query 'Item.control_tower_parameters.M.AccountName.S' \
              --output text 2>/dev/null || echo "NotFound")
            
            if [ "$DDB_ENTRY" != "NotFound" ] && [ "$DDB_ENTRY" != "None" ]; then
              echo "   âœ… Entry found: $DDB_ENTRY"
            else
              echo "   â³ Entry not yet created"
            fi
            
            # Check 3: AWS Organizations
            echo ""
            echo "3ï¸âƒ£ Checking AWS Organizations..."
            ORG_ACCOUNT=$(aws organizations list-accounts \
              --query "Accounts[?Email=='$ACCOUNT_EMAIL'].{Id:Id,Status:Status}" \
              --output json 2>/dev/null || echo "[]")
            
            if [ "$ORG_ACCOUNT" != "[]" ] && [ "$ORG_ACCOUNT" != "" ]; then
              ACCOUNT_ID=$(echo "$ORG_ACCOUNT" | jq -r '.[0].Id')
              ACCOUNT_STATUS=$(echo "$ORG_ACCOUNT" | jq -r '.[0].Status')
              
              echo "   âœ… Account found!"
              echo "   ğŸ“‹ ID: $ACCOUNT_ID"
              echo "   ğŸ¯ Status: $ACCOUNT_STATUS"
              
              if [ "$ACCOUNT_STATUS" = "ACTIVE" ]; then
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ‰ğŸ‰ğŸ‰ ACCOUNT SUCCESSFULLY CREATED! ğŸ‰ğŸ‰ğŸ‰"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "âœ… Account Name: $ACCOUNT_NAME"
                echo "âœ… Account ID: $ACCOUNT_ID"
                echo "âœ… Email: $ACCOUNT_EMAIL"
                echo "âœ… Status: ACTIVE"
                echo "âœ… Time taken: $((i * 2)) minutes"
                echo ""
                ACCOUNT_CREATED=true
                break
              fi
            else
              echo "   â³ Account not yet created"
            fi
            
            # Wait before next check (if not last iteration)
            if [ $i -lt $MAX_WAIT ]; then
              echo ""
              echo "â° Waiting 1 minute before next check..."
              sleep 60
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$ACCOUNT_CREATED" = true ]; then
            echo "âœ… MONITORING COMPLETE - ACCOUNT ACTIVE"
            echo "account_created=true" >> $GITHUB_ENV
            echo "account_id=$ACCOUNT_ID" >> $GITHUB_ENV
          else
            echo "â° MONITORING TIMEOUT REACHED"
            echo "   Account creation may still be in progress"
            echo "   Please check manually at:"
            echo "   https://console.aws.amazon.com/organizations/v2/home/accounts"
            echo "account_created=false" >> $GITHUB_ENV
          fi
      
      - name: ğŸ‰ Final Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ‰ Account Request Processed!
          
          ### ğŸ“‹ Account Information
          | Field | Value |
          |-------|-------|
          | **Name** | ${{ inputs.account_name }} |
          | **Email** | ${{ inputs.account_email }} |
          | **OU** | ${{ inputs.organizational_unit }} |
          | **Environment** | ${{ inputs.environment }} |
          | **Requested By** | @${{ github.actor }} |
          EOF
          
          if [ "${{ env.account_created }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### âœ… Account Successfully Created!
          
          | Detail | Value |
          |--------|-------|
          | **Account ID** | ${{ env.account_id }} |
          | **Status** | ACTIVE |
          | **Creation Time** | ~20 minutes |
          
          ### ğŸ¯ Next Steps
          - Access account via [AWS SSO Portal](https://d-906702c4e1.awsapps.com/start)
          - Account is ready to use immediately
          - Control Tower baseline applied automatically
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### â° Account Creation In Progress
          
          The account is still being provisioned. This can take up to 30 minutes.
          
          **Monitor Progress:**
          - [CodePipeline](https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view)
          - [AWS Organizations](https://console.aws.amazon.com/organizations/v2/home/accounts)
          - [Step Functions](https://ap-south-1.console.aws.amazon.com/states/home?region=ap-south-1)
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ---
          ğŸ¤– **Automated by AFT** | ğŸ”’ **Secured by Control Tower**
          EOF
      
      - name: âœ… Workflow Complete
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ACCOUNT REQUEST SUBMITTED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Account: ${{ inputs.account_name }}"
          echo "Email: ${{ inputs.account_email }}"
          echo "OU: ${{ inputs.organizational_unit }}"
          echo ""
          echo "ğŸ”„ AFT is now processing your request"
          echo "â±ï¸  Account will be ready in ~20 minutes"
          echo ""
          echo "ğŸ“‹ Monitor progress:"
          echo "   - CodePipeline: https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view"
          echo "   - Organizations: https://console.aws.amazon.com/organizations/v2/home/accounts"
          echo ""
          echo "âœ… Workflow completed successfully"

